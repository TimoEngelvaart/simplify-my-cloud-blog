---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntry, render } from "astro:content";
import { Image } from "astro:assets";
import { identity } from "../../config";

// Tell Astro which /blog/:id pages to emit
export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((p) => {
    return { params: { id: p.id } }; // Use p.id directly, no cleaning needed
  });
}

// Runtime for each page:
const { id } = Astro.params;

// Fetch directly by id (no extension needed)
const entry = await getEntry("posts", id);

if (!entry) {
  return Astro.redirect("/blog");
}

const { Content, remarkPluginFrontmatter } = await render(entry);
---

<Layout
  seo={{
    title: entry.data.title,
    description: entry.data.description,
    image: entry.data.image.url,
  }}
>
  <article class="max-w-4xl mx-auto px-6 pt-16 pb-24">
    <!-- Back Link -->
    <a href="/blog" class="inline-flex items-center gap-1 text-sm font-medium opacity-60 hover:opacity-100 transition-opacity mb-8">
      ← Back
    </a>

    <!-- Header Section -->
    <header class="mb-10">
      <h1 class="font-bold text-4xl mb-4 leading-tight">{entry.data.title}</h1>
      <p class="text-lg opacity-60 mb-6 leading-relaxed">
        {entry.data.description}
      </p>

      <!-- Meta Info -->
      <div class="flex items-center gap-4">
        <Image
          src={identity.logo}
          alt={identity.name}
          width={40}
          height={40}
          class="w-[40px] h-[40px] object-cover rounded-full ring-1 ring-gray-200 dark:ring-gray-800"
        />
        <div>
          <p class="font-medium text-sm">{identity.name}</p>
          <div class="flex items-center gap-2 text-xs opacity-50">
            <time datetime={entry.data.pubDate.toISOString()}>
              {entry.data.pubDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
            </time>
            <span>·</span>
            <span>{remarkPluginFrontmatter.minutesRead}</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Featured Image -->
    <div class="mb-12 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-800">
      <Image
        src={entry.data.image.url}
        alt={entry.data.image.alt}
        width={1200}
        height={600}
        class="aspect-video w-full object-cover"
      />
    </div>

    <!-- Article Content -->
    <div class="prose prose-lg dark:prose-invert max-w-none
      prose-headings:font-bold prose-headings:tracking-tight
      prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4
      prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
      prose-p:leading-relaxed prose-p:mb-5 prose-p:opacity-80
      prose-a:font-medium prose-a:no-underline prose-a:opacity-100 hover:prose-a:underline prose-a:underline-offset-2
      prose-strong:font-semibold prose-strong:opacity-100
      prose-code:text-sm prose-code:font-mono prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:bg-secondary prose-code:opacity-100
      prose-pre:bg-secondary prose-pre:border prose-pre:border-gray-200 dark:prose-pre:border-gray-800 prose-pre:rounded-lg prose-pre:text-sm
      prose-img:rounded-lg prose-img:border prose-img:border-gray-200 dark:prose-img:border-gray-800
      prose-blockquote:border-l-2 prose-blockquote:border-gray-300 dark:prose-blockquote:border-gray-700 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:opacity-70
      prose-ul:my-5 prose-ol:my-5 prose-li:my-1">
      <Content />
    </div>

    <!-- Footer Navigation -->
    <footer class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800">
      <a href="/blog" class="inline-flex items-center gap-1 text-sm font-medium opacity-60 hover:opacity-100 transition-opacity">
        ← All posts
      </a>
    </footer>
  </article>
</Layout>
